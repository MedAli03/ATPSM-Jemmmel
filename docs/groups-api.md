# Groupes API

هذا المستند يصف العقود المحدثة الخاصة بإدارة المجموعات، تعيين المربين، وتسجيل الأطفال خلال سنة دراسية.

## تمثيل الحالات المشتركة

جميع الاستجابات الناجحة تتبع النمط:

```json
{ "ok": true, "data": <payload> }
```

عند استعمال ترقيم الصفحات يتم إرجاع الكائن التالي:

```json
{
  "items": [...],
  "meta": {
    "page": 1,
    "limit": 10,
    "total": 37,
    "hasMore": true
  }
}
```

## المجموعات حسب السنة

- `GET /api/groupes?anneeId=&statut=&search=&page=&limit=`
- `POST /api/groupes` لإنشاء مجموعة جديدة (يتطلب `annee_id`، `nom`).
- `PUT /api/groupes/:id` لتعديل الإسم/الوصف/الحالة.
- `PATCH /api/groupes/:id/archive` لتبديل الحالة بين `actif` و`archive`.
- `DELETE /api/groupes/:id?anneeId=` يحذف فقط إذا لم توجد ارتباطات فعالة في تلك السنة.

الخاصية `nb_enfants` في النتائج تمثل عدد الأطفال المسجلين بنشاط (est_active = true) خلال السنة المحددة.

## تسجيل الأطفال في مجموعة

- `GET /api/groupes/:groupeId/inscriptions?anneeId=&page=&limit=`
  - يعيد الأطفال المسجلين حالياً في المجموعة مع بياناتهم الأساسية.
- `POST /api/groupes/annees/:anneeId/:groupeId/inscriptions`
  - الحمولة: `{ "enfant_ids": [1,2,3] }`
  - يضيف الأطفال غير المسجلين أو ينقلهم تلقائياً من مجموعاتهم السابقة في نفس السنة.
  - الاستجابة تلخص العملية: `created`, `transferred`, `skipped`.
- `DELETE /api/groupes/:groupeId/inscriptions/:inscriptionId`
  - لا يُحذف السجل فعلياً بل يتم ختمه بتاريخ خروج مع `est_active = false` للإبقاء على التاريخ.

### مرشح الأطفال

- `GET /api/groupes/annees/:anneeId/candidats/enfants`
  - المتغيرات:
    - `scope=available` (افتراضي) لإرجاع الأطفال غير المرتبطين خلال السنة.
    - `scope=assigned` لعرض الأطفال المرتبطين حالياً بمجموعة أخرى (مع تفاصيل مجموعتهم)، مفيدة للنقل.
    - `search` (اختياري) و `excludeGroupeId` لاستبعاد المجموعة الحالية من النتائج عند النقل.
  - يعيد قائمة بعناصر تحتوي على `inscription_actuelle` عند الحاجة.

## تعيين المربين

- `GET /api/groupes/:groupeId/affectation?anneeId=`
  - يعيد التعيين النشط إن وجد مع تفاصيل المربي.
- `POST /api/groupes/annees/:anneeId/:groupeId/educateur`
  - الحمولة: `{ "educateur_id": 9 }`
  - يتحقق من عدم وجود تعيين نشط لنفس المربي أو المجموعة داخل نفس السنة ويغلق التعيين السابق قبل إنشاء واحد جديد.
- `DELETE /api/groupes/:groupeId/affectation/:affectationId`
  - يعطل التعيين (`est_active = false`, `date_fin_affectation`)، ويحافظ على الأرشيف.

### مرشح المربين

- `GET /api/groupes/annees/:anneeId/candidats/educateurs`
  - يعيد فقط المربين النشطين (`role=EDUCATEUR`, `is_active=1`) الذين لا يملكون تعييناً فعالاً خلال السنة.
  - يدعم `search`, `page`, `limit` كما في بقية النقاط.

## قواعد العمل المضمنة

- طفل واحد فقط يمكن أن يكون مسجلاً بنشاط في مجموعة واحدة لكل سنة دراسية. أي محاولة لنقله تغلق السجل القديم وتُنشئ سجلاً جديداً بتاريخ دخول حديث.
- مربي واحد فقط يمكن أن يُعيَّن بنشاط لكل مجموعة ولكل سنة، ولا يمكن أن يعمل في مجموعتين في نفس السنة.
- عمليات الحذف تستبدل بحالات تعطيل (`est_active = false`) للحفاظ على تاريخ القرارات.
- يتم تنفيذ عمليات النقل/التعيين داخل معاملات (transactions) لضمان الاتساق.

## رسائل الخطأ

- `422` يتم إرجاعها عند فشل التحقق من صحة المدخلات (على سبيل المثال، غياب `educateur_id`).
- `404` عند طلب مجموعة/تسجيل/تعيين غير موجود.
- `409` عند خرق قاعدة العمل (مثل محاولة تعيين مربي مشغول أو محاولة إضافة أطفال جميعهم مسجلون بالفعل في نفس المجموعة).

استخدم هذه النهايات ضمن واجهات المدير لضمان تجربة متناسقة خالية من أخطاء 400/409 غير المتوقعة.
